<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <link href="/css/nav.css" rel="stylesheet" />
    <link href="/css/upload.css" rel="stylesheet" />
    <link href="images/미리보기 사진.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="body">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
      crossorigin="anonymous"
    ></script>
    <script>
      const firebaseConfig = {
        apiKey: 'AIzaSyAH-KOEpyYVknCZUEOh_YLiWHybaOfDIlI',
        authDomain: 'wewrite-92f77.firebaseapp.com',
        projectId: 'wewrite-92f77',
        storageBucket: 'wewrite-92f77.appspot.com',
        messagingSenderId: '286872322873',
        appId: '1:286872322873:web:319f642b13c0375c649ee8',
        measurementId: 'G-3N048SNN6W',
      };

      firebase.initializeApp(firebaseConfig);
    </script>



    <div class="wrapper"><script src="nav.js"></script></div>
    <!--업로드 모달창-->
    <div class="upload-modal">
      <div class="upload-modal-main">
        <h4 class="upload-modal-title">업로드 하시겠습니까?</h4>
        <div>
          <button type="button" class="upload-modal-upload" id="send">올리기</button>
          <button type="button" class="upload-modal-close" id="close">닫기</button>
        </div>
      </div>
    </div>
    <!--메인-->
    <div class="container">
      <div class="wrapper">
            <!--타이틀-->
        <input type="title" class="title" id="title" placeholder="제목" />
            <!--에디터-->
        <div class="upload-editor-menu">
          <button id="btn-bold">
            <b>B</b>
          </button>
          <button id="btn-italic">
            <i>I</i>
          </button>
          <button id="btn-underline">
            <u>U</u>
          </button>
          <button id="btn-strike">
            <s>S</s>
          </button>
          <!--폰트-->
          <select id="select-font-size">
            <option value="">폰트 사이즈</option>
            <option value="1">10px</option>
            <option value="2">13px</option>
            <option value="3">16px</option>
            <option value="4">18px</option>
            <option value="5">24px</option>
            <option value="6">32px</option>
            <option value="7">42px</option>
          </select>
          <select id="select-font-name">
            <option value="">폰트</option>
            <option value="Black Han Sans">Black Han Sans</option>
            <option value="Noto Sans KR">Noto Sans</option>
            <option value="Nanum Gothic">Nanum Gothic</option>
            <option value="Nanum Myeongjo">Nanum Myeongjo</option>
            <option value="Nanum Pen Script">Nanum Pen Script</option>
          </select>
          <select id="select-font-color">
            <option value="">폰트 색상</option>
            <option value="#000000">검정</option>
            <option value="#FFFFFF">흰색</option>
            <option value="#CCCCCC">회색</option>
            <option value="#F03E3E">빨강</option>
            <option value="#1971C2">파랑</option>
            <option value="#37B24D">녹색</option>
          </select>
          <select id="select-font-background">
            <option value="rgba(0, 0, 0, 0)">폰트 백그라운드(없음)</option>
            <option value="#000000">검정</option>
            <option value="#FFFFFF">흰색</option>
            <option value="#CCCCCC">회색</option>
            <option value="#F03E3E">빨강</option>
            <option value="#1971C2">파랑</option>
            <option value="#37B24D">녹색</option>
          </select>

          <button id="btn-ordered-list">OL</button>
          <button id="btn-unordered-list">UL</button>
          <!-- <button id="btn-image">IMG</button> -->

          <div class="form-control mt-2" id="content" contenteditable="true"></div>
          <input class="form-control mt-2" type="file" id="image" value="image" accept="image/*" onchange="readURL(this);" />
          <div class="origin">
            <button  class="upload" id="upload">올리기</button>
              <p class="source">출처가 있을경우 반드시 출처를 남겨주세요.<br/>
              (저작권 위배시 통보없이 삭제될수있습니다.)
              </p>
                
          </div>

        </div>
      </div>
      <h4 class="upload-img-preview">이미지 미리보기<br/>
      (이미지 미리보기만 가능합니다.)
      </h4>

      <!-- 
      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">업로드 하시겠습니까?</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" id="send" class="btn btn-primary">업로드하기</button>
            </div>
          </div>
        </div>
      </div>
    </div>Modal -->
    <div class="upload-previe-box">
      <img id="upload-preview" src="images/미리보기 사진.png" />
    </div>
    <script>
      $('#upload').on('click', function () {
        $('.upload-modal').addClass('show-modal');
      });

      $('#close').on('click', function () {
        $('.upload-modal').removeClass('show-modal');
      });
    </script>
    <script>
      //미리보기
      //https://madinthe90.tistory.com/39  참고
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById('upload-preview').src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          document.getElementById('upload-preview').src = '';
        }
      }
    </script>
    <script>
      const fontSizeSelector = document.getElementById('select-font-size');
      const fontNameSelector = document.getElementById('select-font-name');
      const selectFontColor = document.getElementById('select-font-color');
      const selectFontBackground = document.getElementById('select-font-background');
      // 폰트 사이즈에 따른 값을 찾기 위해서 넣은 배열
      const fontSizeList = [10, 13, 16, 18, 24, 32, 42];

      fontSizeSelector.addEventListener('change', function () {
        changeFontSize(this.value);
      });
      fontNameSelector.addEventListener('change', function () {
        changeFontName(this.value);
      });
      function changeFontName(name) {
        document.execCommand('fontName', false, name);
        focusEditor();
      }

      function changeFontSize(size) {
        document.execCommand('fontSize', false, size);
        focusEditor();
      }
      // 폰트 정보 가져오는 코드 참고 : https://stackoverflow.com/questions/8770008/contenteditable-get-current-font-color-size
      function getComputedStyleProperty(el, propName) {
        if (window.getComputedStyle) {
          return window.getComputedStyle(el, null)[propName];
        } else if (el.currentStyle) {
          return el.currentStyle[propName];
        }
      }

      function reportFont() {
        let containerEl, sel;
        if (window.getSelection) {
          sel = window.getSelection();
          if (sel.rangeCount) {
            containerEl = sel.getRangeAt(0).commonAncestorContainer;
            if (containerEl.nodeType === 3) {
              containerEl = containerEl.parentNode;
            }
          }
        } else if ((sel = document.selection) && sel.type !== 'Control') {
          containerEl = sel.createRange().parentElement();
        }

        if (containerEl) {
          const fontSize = getComputedStyleProperty(containerEl, 'fontSize');
          const fontName = getComputedStyleProperty(containerEl, 'fontFamily');
          const size = parseInt(fontSize.replace('px', ''));
          const fontColor = getComputedStyleProperty(containerEl, 'color');
          const backgroundColor = getComputedStyleProperty(containerEl, 'backgroundColor');
          fontColorSelector.value = rgbToHex(fontColor).toUpperCase();
          // 기본 배경색은 rgba(0, 0, 0, 0)
          if (backgroundColor === 'rgba(0, 0, 0, 0)') {
            fontBackgroundSelector.value = backgroundColor;
          } else {
            fontBackgroundSelector.value = rgbToHex(backgroundColor).toUpperCase();
          }

          fontSizeSelector.value = fontSizeList.indexOf(size) + 1;
          // fontName이 문자열 "폰트명"으로 오기 때문에 "를 제거해주는 코드 추가
          fontNameSelector.value = fontName.replaceAll('"', '');
        }
      }
      selectFontColor.addEventListener('change', function () {
        setFontColor(this.value);
      });

      selectFontBackground.addEventListener('change', function () {
        setFontBackground(this.value);
      });

      function setFontColor(color) {
        document.execCommand('foreColor', false, color);
        focusEditor();
      }

      function setFontBackground(color) {
        document.execCommand('hiliteColor', false, color);
        focusEditor();
      }

      // 폰트 색상 rgb to hex, hex to rgb
      // 참고 : https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
      function componentToHex(c) {
        const hex = parseInt(c).toString(16);
        console.log(hex);
        return hex.length == 1 ? '0' + hex : hex;
      }

      function rgbToHex(color) {
        // rgb(r, g, b)에서 색상값만 뽑아 내기 위해서 rgb() 제거
        const temp = color.replace(/[^0-9,]/g, '');
        // r,g,b만 남은 값을 ,로 [r,g,b] 배열로 변환
        const rgb = temp.split(',');
        return '#' + componentToHex(rgb[0]) + componentToHex(rgb[1]) + componentToHex(rgb[2]);
      }
    </script>
    <script>
      const content = document.getElementById('content');
      const btnBold = document.getElementById('btn-bold');
      const btnItalic = document.getElementById('btn-italic');
      const btnUnderline = document.getElementById('btn-underline');
      const btnStrike = document.getElementById('btn-strike');
      const btnOrderedList = document.getElementById('btn-ordered-list');
      const btnUnorderedList = document.getElementById('btn-unordered-list');
      // const btnImage = document.getElementById('btn-image');
      // const imageSelector = document.getElementById('image');

      btnBold.addEventListener('click', function () {
        setStyle('bold');
      });

      btnItalic.addEventListener('click', function () {
        setStyle('italic');
      });

      btnUnderline.addEventListener('click', function () {
        setStyle('underline');
      });

      btnStrike.addEventListener('click', function () {
        setStyle('strikeThrough');
      });

      btnOrderedList.addEventListener('click', function () {
        setStyle('insertOrderedList');
      });

      btnUnorderedList.addEventListener('click', function () {
        setStyle('insertUnorderedList');
      });

      function setStyle(style) {
        document.execCommand(style);
        focusEditor();
      }

      // btnImage.addEventListener('click', function () {
      //   imageSelector.click();
      // });

      // imageSelector.addEventListener('change', function (e) {
      //   const files = e.target.files;
      //   if (!!files) {
      //     insertImageDate(files[0]);
      //   }
      // });

      // function insertImageDate(file) {
      //   const reader = new FileReader();
      //   reader.addEventListener('load', function (e) {
      //     focusEditor();
      //     document.execCommand('insertImage', false, `${reader.result}`);
      //   });
      //   reader.readAsDataURL(file);
      // }

      // 버튼 클릭 시 에디터가 포커스를 잃기 때문에 다시 에디터에 포커스를 해줌
      function focusEditor() {
        content.focus({ preventScroll: true });
      }
    </script>

    <script>
      const db = firebase.firestore(); //firebase 데이터 읽기
      const storage = firebase.storage(); //storage다루는 문법414

      $('#send').click(function () {
        // 공백검사;
        if (document.getElementById('title').value == '') {
          alert('제목을 입력해 주세요.');
          e.preventDefault();
        }
        if (document.getElementById('content').value == '') {
          alert('글을 작성해주세요.');
          e.preventDefault();
        }
        if (document.getElementById('image').value == '') {
          alert('사진을 넣어 주세요.');
          e.preventDefault();
        }
       
        // 스토리지에 사진저장하는문법 (send버튼을 누르면 )
        var file = document.querySelector('#image').files[0];
        var storageRef = storage.ref();
        var saveRoute = storageRef.child('image/' + file.name); // 위와 여기는 스토리지에 저장할경로
        var uploadRoute = saveRoute.put(file); //put함수로 업로드가능

        uploadRoute.on(
          'state_changed',
          // 변화시 동작하는 함수
          null,
          //에러시 동작하는 함수
          (error) => {
            console.error('실패사유는', error);
          },
          // 성공시 동작하는 함수
          () => {
            uploadRoute.snapshot.ref.getDownloadURL().then((url) => {
              console.log('업로드된 경로는', url);

              //유저의 로그인상태확인
              firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                  console.log(user.uid);
                  $('#userName').html(user.displayName); //navbar에 유저이름 나타내기
                }
                var save = {
                  //저장할거
                  title: $('#title').val(),
                  //.text를 사용하면 글꼴 ,컬러가 적용되지않는다. .html을 사용하면 글꼴 칼라정보가 모두 같이넘어온다
                  content: $('#content').html(),
                  // content: $('#content').attr('value'),
                  date: new Date(),
                  image: url,
                  uid: user.uid,
                  name: user.displayName,
                };
                db.collection('write')
                  .add(save)
                  .then((result) => {
                    //then 성공했을때 실행되는 함수
                    console.log(result);
                    window.location.href = '/index.html';
                  })
                  .catch((error) => {
                    console.log(error);
                  }); //catch실패했을때 실행되는 함수
              });
            });
          }
        );
      });
    </script>
    <script></script>
  </body>
</html>
